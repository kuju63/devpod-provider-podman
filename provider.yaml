name: podman
version: v0.2.0
home: https://github.com/kuju63/devpod-provider-podman
description: |-
  DevPod on Podman

optionGroups:
  - name: "Basic Options"
    options:
      - PODMAN_PATH
      - INACTIVITY_TIMEOUT
  - name: "Machine Management"
    options:
      - PODMAN_MACHINE_AUTO_START
      - PODMAN_MACHINE_AUTO_INIT
      - PODMAN_MACHINE_NAME
      - PODMAN_MACHINE_START_TIMEOUT
  - name: "Machine Resources"
    options:
      - PODMAN_MACHINE_CPUS
      - PODMAN_MACHINE_MEMORY
      - PODMAN_MACHINE_DISK_SIZE
      - PODMAN_MACHINE_ROOTFUL
      - PODMAN_MACHINE_AUTO_RESOURCE_UPDATE

options:
  INACTIVITY_TIMEOUT:
    description: "If defined, will automatically stop the container after the inactivity period. Examples: 10m, 1h"

  PODMAN_PATH:
    description: The path where to find the podman binary.
    default: podman

  PODMAN_MACHINE_AUTO_START:
    description: "Automatically start Podman Machine if it is stopped (macOS only)."
    default: "true"

  PODMAN_MACHINE_AUTO_INIT:
    description: "Automatically initialize Podman Machine if it does not exist (macOS only)."
    default: "false"

  PODMAN_MACHINE_NAME:
    description: "Name of the Podman Machine to use. If empty, auto-detects the first available machine."

  PODMAN_MACHINE_START_TIMEOUT:
    description: "Timeout in seconds to wait for Podman Machine to start."
    default: "60"

  PODMAN_MACHINE_CPUS:
    description: "Number of CPUs to allocate to Podman Machine. Only used during machine creation."
    default: "2"

  PODMAN_MACHINE_MEMORY:
    description: "Memory in MB to allocate to Podman Machine. Only used during machine creation."
    default: "4096"

  PODMAN_MACHINE_DISK_SIZE:
    description: "Disk size in GB to allocate to Podman Machine. Only used during machine creation."
    default: "100"

  PODMAN_MACHINE_ROOTFUL:
    description: "Run Podman Machine in rootful mode. Allows privileged operations but less secure."
    default: "false"

  PODMAN_MACHINE_AUTO_RESOURCE_UPDATE:
    description: "Automatically update Podman Machine resources in-place when configuration mismatch is detected. Uses 'podman machine set' without recreating the machine."
    default: "false"

agent:
  containerInactivityTimeout: ${INACTIVITY_TIMEOUT}
  local: true
  docker:
    path: ${PODMAN_PATH}
    install: false

exec:
  init: |-
    #!/bin/bash
    set -e

    # Check if podman command exists
    if ! command -v ${PODMAN_PATH} &> /dev/null; then
      >&2 echo "Error: Podman binary not found at '${PODMAN_PATH}'"
      >&2 echo "Please install Podman: brew install podman"
      >&2 echo "Or set PODMAN_PATH option to the correct location."
      exit 1
    fi

    # Check Podman version
    PODMAN_VERSION=$(${PODMAN_PATH} --version | awk '{print $3}')
    echo "Found Podman version: ${PODMAN_VERSION}"

    # Podman Machine management (macOS only)
    if [[ "$OSTYPE" == "darwin"* ]]; then
      echo "Checking Podman Machine status..."

      # Resolve machine name
      MACHINE_NAME="${PODMAN_MACHINE_NAME:-}"
      if [ -z "$MACHINE_NAME" ]; then
        MACHINE_NAME=$(${PODMAN_PATH} machine list --format '{{.Name}}' --noheading 2>/dev/null | head -n1 || echo "")
        if [ -n "$MACHINE_NAME" ]; then
          echo "Auto-detected machine: $MACHINE_NAME"
        fi
      fi

      # Check if machine exists
      if [ -z "$MACHINE_NAME" ]; then
        if [ "${PODMAN_MACHINE_AUTO_INIT:-false}" = "true" ]; then
          echo "Creating new Podman Machine..."
          MACHINE_NAME="devpod-machine"

          INIT_CMD="${PODMAN_PATH} machine init \"$MACHINE_NAME\""
          INIT_CMD="$INIT_CMD --cpus ${PODMAN_MACHINE_CPUS:-2}"
          INIT_CMD="$INIT_CMD --memory ${PODMAN_MACHINE_MEMORY:-4096}"
          INIT_CMD="$INIT_CMD --disk-size ${PODMAN_MACHINE_DISK_SIZE:-100}"

          if [ "${PODMAN_MACHINE_ROOTFUL:-false}" = "true" ]; then
            INIT_CMD="$INIT_CMD --rootful"
          fi

          eval $INIT_CMD
          echo "Machine created successfully: $MACHINE_NAME"
        else
          >&2 echo "Error: No Podman Machine found."
          >&2 echo ""
          >&2 echo "Manual fix:"
          >&2 echo "  podman machine init"
          >&2 echo "  podman machine start"
          >&2 echo ""
          >&2 echo "Or enable auto-init:"
          >&2 echo "  devpod provider set-options podman PODMAN_MACHINE_AUTO_INIT=true"
          exit 1
        fi
      fi

      # Check machine state
      MACHINE_STATE=$(${PODMAN_PATH} machine inspect "$MACHINE_NAME" --format '{{.State}}' 2>/dev/null || echo "unknown")
      echo "Machine '$MACHINE_NAME' state: $MACHINE_STATE"

      if [ "$MACHINE_STATE" != "running" ]; then
        if [ "${PODMAN_MACHINE_AUTO_START:-true}" = "true" ]; then
          echo "Starting Podman Machine '$MACHINE_NAME'..."
          ${PODMAN_PATH} machine start "$MACHINE_NAME"

          # Wait for machine to be ready
          TIMEOUT=${PODMAN_MACHINE_START_TIMEOUT:-60}
          ELAPSED=0
          echo "Waiting for machine to be ready (timeout: ${TIMEOUT}s)..."

          while [ $ELAPSED -lt $TIMEOUT ]; do
            if ${PODMAN_PATH} ps >/dev/null 2>&1; then
              echo "Podman Machine ready after ${ELAPSED}s"
              break
            fi
            sleep 2
            ELAPSED=$((ELAPSED + 2))
          done

          if [ $ELAPSED -ge $TIMEOUT ]; then
            >&2 echo "Error: Machine start timed out after ${TIMEOUT}s"
            >&2 echo ""
            >&2 echo "You can increase the timeout:"
            >&2 echo "  devpod provider set-options podman PODMAN_MACHINE_START_TIMEOUT=120"
            exit 1
          fi
        else
          >&2 echo "Error: Podman Machine '$MACHINE_NAME' is not running."
          >&2 echo ""
          >&2 echo "Manual fix:"
          >&2 echo "  podman machine start $MACHINE_NAME"
          >&2 echo ""
          >&2 echo "Or enable auto-start:"
          >&2 echo "  devpod provider set-options podman PODMAN_MACHINE_AUTO_START=true"
          exit 1
        fi
      else
        echo "Machine is already running."

        # Check for resource configuration mismatch
        if [ "${PODMAN_MACHINE_AUTO_INIT}" != "true" ]; then
          MACHINE_INFO=$(${PODMAN_PATH} machine inspect "$MACHINE_NAME" 2>/dev/null)
          if [ $? -eq 0 ] && [ -n "$MACHINE_INFO" ]; then
            # Parse current machine configuration
            CURRENT_CPUS=$(echo "$MACHINE_INFO" | grep -o '"CPUs": *[0-9]*' | awk '{print $2}')
            CURRENT_MEMORY=$(echo "$MACHINE_INFO" | grep -o '"Memory": *[0-9]*' | awk '{print $2}')
            CURRENT_DISK=$(echo "$MACHINE_INFO" | grep -o '"DiskSize": *[0-9]*' | awk '{print $2}')
            CURRENT_ROOTFUL=$(echo "$MACHINE_INFO" | grep -o '"Rootful": *[a-z]*' | awk '{print $2}')

            # Get desired configuration (with defaults)
            DESIRED_CPUS="${PODMAN_MACHINE_CPUS:-2}"
            DESIRED_MEMORY="${PODMAN_MACHINE_MEMORY:-4096}"
            DESIRED_DISK="${PODMAN_MACHINE_DISK_SIZE:-100}"
            DESIRED_ROOTFUL="${PODMAN_MACHINE_ROOTFUL:-false}"

            # Normalize rootful values for comparison
            NORM_CURRENT_ROOTFUL="false"
            if [ "$CURRENT_ROOTFUL" = "true" ] || [ "$CURRENT_ROOTFUL" = "1" ]; then
              NORM_CURRENT_ROOTFUL="true"
            fi

            # Detect mismatches
            MISMATCHES=""
            MISMATCH_CPUS=false
            MISMATCH_MEMORY=false
            MISMATCH_DISK=false
            MISMATCH_ROOTFUL=false

            if [ "$CURRENT_CPUS" != "$DESIRED_CPUS" ]; then
              MISMATCHES="${MISMATCHES}  â€¢ CPUs: Current=${CURRENT_CPUS}, Desired=${DESIRED_CPUS}\n"
              MISMATCH_CPUS=true
            fi
            if [ "$CURRENT_MEMORY" != "$DESIRED_MEMORY" ]; then
              MISMATCHES="${MISMATCHES}  â€¢ Memory: Current=${CURRENT_MEMORY}MB, Desired=${DESIRED_MEMORY}MB\n"
              MISMATCH_MEMORY=true
            fi
            if [ "$CURRENT_DISK" != "$DESIRED_DISK" ]; then
              MISMATCHES="${MISMATCHES}  â€¢ Disk Size: Current=${CURRENT_DISK}GB, Desired=${DESIRED_DISK}GB\n"
              MISMATCH_DISK=true
            fi
            if [ "$NORM_CURRENT_ROOTFUL" != "$DESIRED_ROOTFUL" ]; then
              MISMATCHES="${MISMATCHES}  â€¢ Rootful Mode: Current=${NORM_CURRENT_ROOTFUL}, Desired=${DESIRED_ROOTFUL}\n"
              MISMATCH_ROOTFUL=true
            fi

            # Handle mismatches if found
            if [ -n "$MISMATCHES" ]; then
              if [ "${PODMAN_MACHINE_AUTO_RESOURCE_UPDATE:-false}" = "true" ]; then
                # Automatic resource update
                echo ""
                echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                echo "ðŸ”§ Applying resource configuration updates to machine '$MACHINE_NAME'..."
                echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                echo ""
                echo "Current configuration:"
                echo "  â€¢ CPUs: $CURRENT_CPUS"
                echo "  â€¢ Memory: ${CURRENT_MEMORY}MB"
                echo "  â€¢ Disk Size: ${CURRENT_DISK}GB"
                echo "  â€¢ Rootful: $NORM_CURRENT_ROOTFUL"
                echo ""
                echo "Desired configuration:"
                echo "  â€¢ CPUs: $DESIRED_CPUS"
                echo "  â€¢ Memory: ${DESIRED_MEMORY}MB"
                echo "  â€¢ Disk Size: ${DESIRED_DISK}GB"
                echo "  â€¢ Rootful: $DESIRED_ROOTFUL"
                echo ""

                # Check for disk size decrease (not supported)
                if [ "$MISMATCH_DISK" = true ] && [ "$DESIRED_DISK" -lt "$CURRENT_DISK" ]; then
                  >&2 echo "âŒ Error: Cannot decrease disk size from ${CURRENT_DISK}GB to ${DESIRED_DISK}GB"
                  >&2 echo "Disk size can only be increased, not decreased."
                  >&2 echo ""
                  >&2 echo "Options:"
                  >&2 echo "  1. Keep current disk size (${CURRENT_DISK}GB)"
                  >&2 echo "  2. Recreate machine with smaller disk (âš ï¸  Data loss)"
                  >&2 echo ""
                  >&2 echo "Continuing with other resource updates..."
                  >&2 echo ""
                  MISMATCH_DISK=false
                fi

                # Stop machine for resource updates
                echo "Stopping machine '$MACHINE_NAME'..."
                if ! ${PODMAN_PATH} machine stop "$MACHINE_NAME" 2>&1; then
                  >&2 echo ""
                  >&2 echo "âŒ Error: Failed to stop machine"
                  >&2 echo "Cannot proceed with resource updates."
                  exit 1
                fi

                # Apply resource updates
                UPDATE_SUCCESS=true

                if [ "$MISMATCH_CPUS" = true ]; then
                  echo "Updating CPUs to ${DESIRED_CPUS}..."
                  if ! ${PODMAN_PATH} machine set "$MACHINE_NAME" --cpus "$DESIRED_CPUS" 2>&1; then
                    >&2 echo "âš ï¸  Warning: Failed to update CPUs"
                    UPDATE_SUCCESS=false
                  fi
                fi

                if [ "$MISMATCH_MEMORY" = true ]; then
                  echo "Updating memory to ${DESIRED_MEMORY}MB..."
                  if ! ${PODMAN_PATH} machine set "$MACHINE_NAME" --memory "$DESIRED_MEMORY" 2>&1; then
                    >&2 echo "âš ï¸  Warning: Failed to update memory"
                    UPDATE_SUCCESS=false
                  fi
                fi

                if [ "$MISMATCH_DISK" = true ]; then
                  echo "Updating disk size to ${DESIRED_DISK}GB..."
                  if ! ${PODMAN_PATH} machine set "$MACHINE_NAME" --disk-size "$DESIRED_DISK" 2>&1; then
                    >&2 echo "âš ï¸  Warning: Failed to update disk size"
                    UPDATE_SUCCESS=false
                  fi
                fi

                if [ "$MISMATCH_ROOTFUL" = true ]; then
                  echo "Updating rootful mode to ${DESIRED_ROOTFUL}..."
                  if [ "$DESIRED_ROOTFUL" = "true" ]; then
                    if ! ${PODMAN_PATH} machine set "$MACHINE_NAME" --rootful 2>&1; then
                      >&2 echo "âš ï¸  Warning: Failed to update rootful mode"
                      UPDATE_SUCCESS=false
                    fi
                  else
                    if ! ${PODMAN_PATH} machine set "$MACHINE_NAME" --rootful=false 2>&1; then
                      >&2 echo "âš ï¸  Warning: Failed to update rootful mode"
                      UPDATE_SUCCESS=false
                    fi
                  fi
                fi

                # Restart machine
                echo ""
                echo "Starting machine '$MACHINE_NAME' with updated configuration..."
                if ! ${PODMAN_PATH} machine start "$MACHINE_NAME" 2>&1; then
                  >&2 echo ""
                  >&2 echo "âŒ Error: Failed to start machine after resource updates"
                  >&2 echo "Machine state may be inconsistent. Please check:"
                  >&2 echo "  podman machine list"
                  >&2 echo "  podman machine inspect $MACHINE_NAME"
                  exit 1
                fi

                # Wait for machine to be ready
                TIMEOUT=${PODMAN_MACHINE_START_TIMEOUT:-60}
                ELAPSED=0
                echo "Waiting for machine to be ready (timeout: ${TIMEOUT}s)..."

                while [ $ELAPSED -lt $TIMEOUT ]; do
                  if ${PODMAN_PATH} ps >/dev/null 2>&1; then
                    echo "Machine ready after ${ELAPSED}s"
                    break
                  fi
                  sleep 2
                  ELAPSED=$((ELAPSED + 2))
                done

                if [ $ELAPSED -ge $TIMEOUT ]; then
                  >&2 echo "âŒ Error: Machine start timed out after ${TIMEOUT}s"
                  exit 1
                fi

                # Verify updates
                echo ""
                echo "Verifying updated configuration..."
                UPDATED_INFO=$(${PODMAN_PATH} machine inspect "$MACHINE_NAME" 2>/dev/null)
                if [ $? -eq 0 ] && [ -n "$UPDATED_INFO" ]; then
                  UPDATED_CPUS=$(echo "$UPDATED_INFO" | grep -o '"CPUs": *[0-9]*' | awk '{print $2}')
                  UPDATED_MEMORY=$(echo "$UPDATED_INFO" | grep -o '"Memory": *[0-9]*' | awk '{print $2}')
                  UPDATED_DISK=$(echo "$UPDATED_INFO" | grep -o '"DiskSize": *[0-9]*' | awk '{print $2}')
                  UPDATED_ROOTFUL=$(echo "$UPDATED_INFO" | grep -o '"Rootful": *[a-z]*' | awk '{print $2}')

                  echo "Updated configuration:"
                  echo "  â€¢ CPUs: $UPDATED_CPUS"
                  echo "  â€¢ Memory: ${UPDATED_MEMORY}MB"
                  echo "  â€¢ Disk Size: ${UPDATED_DISK}GB"
                  echo "  â€¢ Rootful: $UPDATED_ROOTFUL"
                fi

                if [ "$UPDATE_SUCCESS" = true ]; then
                  echo ""
                  echo "âœ… Resource configuration updated successfully!"
                else
                  >&2 echo ""
                  >&2 echo "âš ï¸  Some resource updates failed. Check logs above."
                fi
                echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                echo ""
              else
                # Display warning with non-destructive update options
                >&2 echo ""
                >&2 echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                >&2 echo "âš ï¸  WARNING: Machine resource configuration mismatch detected"
                >&2 echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                >&2 echo ""
                >&2 echo "The Podman Machine '$MACHINE_NAME' exists with different resource"
                >&2 echo "settings than requested."
                >&2 echo ""
                >&2 echo "Configuration differences:"
                >&2 echo -e "$MISMATCHES"
                >&2 echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                >&2 echo ""
                >&2 echo "OPTION 1: Update in-place (Non-destructive, recommended)"
                >&2 echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                >&2 echo ""
                >&2 echo "Use 'podman machine set' to update resources without data loss:"
                >&2 echo ""
                >&2 echo "  podman machine stop $MACHINE_NAME"

                if [ "$MISMATCH_CPUS" = true ]; then
                  >&2 echo "  podman machine set $MACHINE_NAME --cpus $DESIRED_CPUS"
                fi
                if [ "$MISMATCH_MEMORY" = true ]; then
                  >&2 echo "  podman machine set $MACHINE_NAME --memory $DESIRED_MEMORY"
                fi
                if [ "$MISMATCH_DISK" = true ]; then
                  if [ "$DESIRED_DISK" -lt "$CURRENT_DISK" ]; then
                    >&2 echo "  # âš ï¸  Disk size cannot be decreased (current: ${CURRENT_DISK}GB, desired: ${DESIRED_DISK}GB)"
                  else
                    >&2 echo "  podman machine set $MACHINE_NAME --disk-size $DESIRED_DISK"
                  fi
                fi
                if [ "$MISMATCH_ROOTFUL" = true ]; then
                  if [ "$DESIRED_ROOTFUL" = "true" ]; then
                    >&2 echo "  podman machine set $MACHINE_NAME --rootful"
                  else
                    >&2 echo "  podman machine set $MACHINE_NAME --rootful=false"
                  fi
                fi

                >&2 echo "  podman machine start $MACHINE_NAME"
                >&2 echo ""
                >&2 echo "Or enable automatic updates:"
                >&2 echo "  devpod provider set-options podman PODMAN_MACHINE_AUTO_RESOURCE_UPDATE=true"
                >&2 echo ""
                >&2 echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                >&2 echo ""
                >&2 echo "OPTION 2: Recreate machine (Destructive)"
                >&2 echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                >&2 echo ""
                >&2 echo "  1. Stop and delete the machine (âš ï¸  This will remove all data):"
                >&2 echo "     podman machine stop $MACHINE_NAME"
                >&2 echo "     podman machine rm $MACHINE_NAME"
                >&2 echo ""
                >&2 echo "  2. Recreate with DevPod (auto-init must be enabled):"
                >&2 echo "     devpod provider set-options podman PODMAN_MACHINE_AUTO_INIT=true"
                >&2 echo "     devpod up <your-workspace> --provider podman"
                >&2 echo ""
                >&2 echo "  Or manually create with specific resources:"
                >&2 echo "     podman machine init $MACHINE_NAME \\"
                >&2 echo "       --cpus $DESIRED_CPUS \\"
                >&2 echo "       --memory $DESIRED_MEMORY \\"
                >&2 echo "       --disk-size $DESIRED_DISK"
                if [ "$DESIRED_ROOTFUL" = "true" ]; then
                  >&2 echo "       --rootful"
                fi
                >&2 echo ""
                >&2 echo "Continuing with existing machine configuration..."
                >&2 echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                >&2 echo ""
              fi
            fi
          fi
        fi
      fi
    fi

    # Test podman connectivity
    echo "Testing Podman connectivity..."
    ${PODMAN_PATH} ps >/dev/null 2>&1
    if [ $? -ne 0 ]; then
      >&2 echo "Error: Podman is not reachable."
      if [[ "$OSTYPE" == "darwin"* ]]; then
        >&2 echo "This should not happen after machine management."
        >&2 echo "Please check: podman machine list"
      else
        >&2 echo "Please ensure Podman is running properly."
      fi
      exit 1
    fi

    echo "Podman provider initialized successfully."

  command: |-
    "${DEVPOD}" helper sh -c "${COMMAND}"
